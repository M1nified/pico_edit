<div class="simplemde-container">
  <textarea id="simplemde"></textarea>
</div>

<script src="{{ base_url }}/plugins/pico_edit/libs/simplemde-markdown-editor/simplemde.min.js"></script>
<link rel="stylesheet" href="{{ base_url }}/plugins/pico_edit/libs/simplemde-markdown-editor/simplemde.min.css">

<script>
  var unsaved = false;
  var currentFile = null;
  var simplemde = new SimpleMDE({
    element: document.getElementById("simplemde"),
    spellChecker: false,
  });

  // New
  $('.controls .new').on('click', function (e) {
    e.preventDefault();
    var title = prompt('Enter page title; optionally with path, example: sub folder/my page', '');
    if (title != null && title != '') {
      $.post('{{ pico_edit_url }}/new', { title: title }, function (data) {
        console.log(data)
        if (data.error) {
          alert(data.error);
        }
        else {
          $('.nav .post').removeClass('open');
          currentFile = data.file;
          simplemde.value(data.content)
          unsaved = false;
          document.title = document.title.replace(' *', '');
          $('.nav').prepend('<li><a href="#" data-url="' + data.file + '" class="post open"><span class="icon-file-text2 marg-r5" aria-hidden="true"></span>/' + data.file + '</a><a href="' + data.url + '" target="_blank" class="view" title="View"><span class="icon icon-eye marg-r5" aria-hidden="true"></span></a><a href="#" data-url="' + data.file + '" class="delete" title="Delete"><span class="icon icon-bin marg-r5" aria-hidden="true"></span></a></li>')
        }
      }, 'json');
    }
  });

  // Open post
  $('.nav,.nav0').on('click', '.post', function (e) {
    e.preventDefault();
    if (unsaved && !confirm('You have unsaved changes. Are you sure you want to leave this post?')) return false;
    $('.nav .post,.nav0 .post').removeClass('open');
    $(this).addClass('open');

    var fileUrl = $(this).attr('data-url');
    $.post('{{ pico_edit_url }}/open', { file: fileUrl }, function (data) {
      currentFile = fileUrl;
      simplemde.value(data)
      unsaved = false;
      document.title = document.title.replace(' *', '');
    });
  });

  // TODO: Autosave

  // btn - Delete
  $('.nav').on('click', '.delete', function (e) {
    e.preventDefault();
    if (!confirm('Are you sure you want to delete this file?')) return false;
    $('.nav .post').removeClass('open');

    var li = $(this).parents('li');
    var fileUrl = $(this).attr('data-url');
    $.post('{{ pico_edit_url }}/delete', { file: fileUrl }, function (data) {
      li.remove();
      currentFile = null;
      simplemde.value('');
      unsaved = false;
      document.title = document.title.replace(' *', '');
    });
  });

  // btn - Save
  $('.controls').on('click', '.savebutton', function (e) {
    e.preventDefault();
    if (!currentFile) return;
    $('#saving').text('Saving...').addClass('active');
    $.post('{{ pico_edit_url }}/save', { file: currentFile, content: simplemde.value() }, function (data) {
      $('#saving').text('Saved');
      unsaved = false;
      document.title = document.title.replace(' *', '');
      setTimeout(function () {
        $('#saving').removeClass('active');
      }, 1000);
    });
  });

</script>

<style>
  .simplemde-container {
    padding: 1em 1em 1em calc(250px + 1em);
  }
  
  .CodeMirror {
    min-height: 100px;
    height: calc(100vh - 170px);
  }
  
  #main {
    z-index: 2;
  }
</style>